<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deporte Conecta ‚Äî Mapa</title>

  <!-- Fuente usada en la Home -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/style.css"/>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- DataService -->
  <script src="js/dataService.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!DS.isLoggedIn()) {
        location.href = 'auth.html';
        return;
      }
      const u = DS.getUserById(DS.getSessionUserId());
      document.getElementById('topUser').textContent =
        u?.name || u?.username || 'Usuario';
    });
  </script>

  <style>
    /* ===== Mejoras visuales espec√≠ficas del MAPA ===== */
    body.map-body{
      font-family: 'Poppins', sans-serif;
    }

    /* ============================================================
       PANEL SUPERIOR ‚Äî NUEVO DISE√ëO PREMIUM
    ============================================================ */
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 20px;
      background: linear-gradient(
          135deg,
          rgba(78, 115, 255, 0.95),
          rgba(147, 104, 255, 0.95)
      );
      border-bottom:1px solid rgba(255,255,255,0.25);
      backdrop-filter: blur(14px);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      animation: fadeDown .45s both;
    }

    @keyframes fadeDown{
      from{ opacity:0; transform: translateY(-16px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* BOT√ìN VOLVER */
    .top-bar .back{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border-radius:12px;
      background: rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.32);
      color:#fff;
      font-weight:600;
      font-size:0.95rem;
      text-decoration:none;
      backdrop-filter: blur(6px);
      transition: all .20s ease;
    }

    .top-bar .back:hover{
      background: rgba(255,255,255,0.30);
      transform: translateY(-3px);
    }

    /* CONTENEDORES DE FILTROS */
    .filters{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Inputs del top bar */
    .top-bar .select,
    .top-bar .input{
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.30);
      border-radius:12px;
      color:white;
      padding:.65rem .9rem;
      font-size:.92rem;
      transition: border-color .25s ease, box-shadow .25s ease;
    }

    /* Autocompletado */
    #searchResults{
      position:absolute;
      margin-top:4px;
      background:rgba(15,20,40,0.96);
      border:1px solid rgba(255,255,255,0.22);
      border-radius:12px;
      width:240px;
      z-index:2000;
      padding:6px 0;
      list-style:none;
    }

    #searchResults li{
      padding:8px 12px;
      cursor:pointer;
      font-size:.9rem;
      border-bottom:1px solid rgba(255,255,255,0.12);
    }

    #searchResults li:hover{
      background:rgba(255,255,255,0.12);
    }

    #topUser{ font-weight:700; }

    /* PANEL TORNEOS */
    #tournamentPanel{
      position: fixed;
      right:16px;
      top:130px;
      width:350px;
      padding:18px;
      background: rgba(20, 24, 40, 0.92);
      border:1px solid rgba(255,255,255,0.22);
      border-radius:16px;
      box-shadow:0 12px 35px rgba(0,0,0,.45);
      backdrop-filter:blur(12px);
      z-index:1000;
      color:white;
    }

    #tournamentPanel[hidden]{ display:none; }

    .grid2{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
  </style>

</head>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (!DS.isLoggedIn()) return;

    const myId = DS.getSessionUserId();
    const all = JSON.parse(localStorage.getItem("dc_chats") || "{}");

    let totalUnread = 0;

    Object.values(all).forEach(chat => {
      chat.forEach(msg => {
        if (msg.from !== myId && !msg.read) totalUnread++;
      });
    });

    const btn = document.getElementById("btnChats");
    if (!btn) return;

    if (totalUnread > 0){
      btn.textContent = `üí¨ Chats (${totalUnread})`;
    } else {
      btn.textContent = "üí¨ Chats";
    }
  });
</script>

<body class="map-body">

  <!-- ========================================== -->
  <!-- ============== BARRA SUPERIOR ============ -->
  <!-- ========================================== -->
  <header class="top-bar">

    <a href="index.html" class="back">‚¨Ö Volver</a>

    <!-- Filtros -->
    <div class="filters">
      <select id="sportFilter" class="select">
        <option value="">Todos los deportes</option>
        <option>F√∫tbol</option>
        <option>F√∫tsal</option>
        <option>Baloncesto</option>
        <option>Voleibol</option>
        <option>Ciclismo</option>
        <option>Running</option>
        <option>Nataci√≥n</option>
        <option>Tenis</option>
        <option>Gym</option>
        <option>Senderismo</option>
        <option>Crossfit</option>
      </select>

      <div style="position:relative;">
        <input id="searchText" class="input" placeholder="Buscar lugares reales‚Ä¶"/>
        <ul id="searchResults" hidden></ul>
      </div>

      <button id="btnClear" class="button button--ghost">Limpiar</button>
      <button id="btnAddMode" class="button">‚ûï A√±adir</button>

      <!-- ‚≠ê NUEVO BOT√ìN TORNEOS -->
      <button id="btnTournamentMode" class="button button--ghost">üèÜ Torneos</button>

      <button id="btnFav" class="button button--ghost">‚òÖ Favoritos</button>
      <button id="btnNear" class="button button--ghost">üìç Cerca</button>
    </div>

    <!-- Usuario -->
    <div class="filters">
      <span>Hola, <strong id="topUser">Usuario</strong></span>

      <!-- üí¨ NUEVO: bot√≥n Mensajes con el mismo estilo minimalista -->
      <a href="chat_list.html" class="button button--ghost">üí¨ Mensajes</a>

      <button id="btnLogout" class="button button--ghost">Salir</button>
    </div>
  </header>



  <!-- MAPA -->
  <div id="map" class="map"></div>
  <div id="statsBar" class="header-small" style="padding:8px 16px; opacity:.95;"></div>


  <!-- ======================================================
       PANEL A√ëADIR LUGAR NORMAL
       ====================================================== -->
  <aside id="addPanel" class="card floating-panel" hidden>
    <h2>Nuevo lugar</h2>
    <p>Activa "A√±adir" y haz clic en el mapa.</p>

    <div class="grid2">
      <label>
        <span>Nombre del lugar</span>
        <input id="name" class="input"/>
      </label>

      <label>
        <span>Deporte</span>
        <select id="sport" class="select">
          <option>F√∫tbol</option>
          <option>F√∫tsal</option>
          <option>Baloncesto</option>
          <option>Voleibol</option>
          <option>Ciclismo</option>
          <option>Running</option>
          <option>Nataci√≥n</option>
          <option>Tenis</option>
          <option>Gym</option>
          <option>Senderismo</option>
          <option>Crossfit</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:8px">
      <span>Horario</span>
      <input id="hours" class="input"/>
    </label>

    <label style="display:block; margin-top:8px">
      <span>M√°s informaci√≥n</span>
      <input id="more" class="input"/>
    </label>

    <div class="form-buttons">
      <button id="btnCancelAdd" class="button button--ghost">Cancelar</button>
      <button id="btnSave" class="button">Guardar</button>
    </div>
  </aside>



  <!-- ======================================================
       ‚≠ê PANEL DE TORNEOS / PUNTOS DE ENCUENTRO
       ====================================================== -->
  <aside id="tournamentPanel" hidden>
    <h2>Nuevo torneo / punto</h2>
    <p>Haz clic en el mapa para elegir la ubicaci√≥n.</p>

    <label>
      <span>Nombre</span>
      <input id="tName" class="input"/>
    </label>

    <label style="display:block; margin-top:8px">
      <span>Deporte</span>
      <select id="tSport" class="select">
        <option>F√∫tbol</option>
        <option>F√∫tsal</option>
        <option>Baloncesto</option>
        <option>Voleibol</option>
        <option>Ciclismo</option>
        <option>Running</option>
        <option>Nataci√≥n</option>
        <option>Tenis</option>
        <option>Gym</option>
        <option>Senderismo</option>
        <option>Crossfit</option>
      </select>
    </label>

    <div class="grid2" style="margin-top:8px;">
      <label>
        <span>Tipo</span>
        <select id="tType" class="select">
          <option value="tournament">üèÜ Torneo</option>
          <option value="meetpoint">üö© Punto de encuentro</option>
        </select>
      </label>

      <label>
        <span>Duraci√≥n</span>
        <select id="tDuration" class="select">
          <option value="2">2 horas</option>
          <option value="3">3 horas</option>
          <option value="4">4 horas</option>
          <option value="5">5 horas</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:8px">
      <span>M√°s informaci√≥n</span>
      <input id="tInfo" class="input"/>
    </label>

    <div class="form-buttons">
      <button id="btnCancelTournament" class="button button--ghost">Cancelar</button>
      <button id="btnSaveTournament" class="button">Guardar</button>
    </div>
  </aside>



  <!-- PANEL FAVORITOS -->
  <aside id="favPanel" class="side-panel" hidden>
    <div class="side-head">
      <strong>Mis favoritos</strong>
      <button id="btnCloseFav" class="button button--ghost">Cerrar</button>
    </div>
    <div id="favList"></div>
  </aside>



  <!-- PANEL CERCA DE MI -->
  <div id="nearPanel" class="near-panel" hidden>
    <div class="near-head">
      <h3>Cerca de m√≠</h3>
      <button class="button button--ghost" id="btnCloseNear">Cerrar</button>
    </div>

    <div class="near-section">
      <label>Ubicaci√≥n</label>
      <div class="near-buttons">
        <button class="button" id="btnNearLocate">üìç Usar mi ubicaci√≥n</button>
        <button class="button button--ghost" id="btnNearSelect">üñ±Ô∏è Seleccionar en el mapa</button>
      </div>
    </div>

    <div class="near-section">
      <label>Radio (km)</label>
      <input id="nearRadius" type="number" class="input" value="3" min="0.1" step="0.1"/>
    </div>

    <div class="near-actions">
      <button class="button" id="btnNearApply">Aplicar</button>
      <button class="button button--ghost" id="btnNearClear">Limpiar</button>
    </div>
  </div>



  <!-- MODAL INFO -->
  <section id="infoModal" class="modal" hidden>
    <div class="modal-backdrop" data-close></div>

    <article class="modal-card">
      <div class="modal-head">
        <h3 id="infoTitle">Informaci√≥n del lugar</h3>
        <button id="infoClose" class="button button--ghost">Cerrar</button>
      </div>
      <div id="infoBody" class="modal-body"></div>
    </article>
  </section>


  <!-- JS PRINCIPAL -->
  <script src="js/map.js"></script>

  <script>
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      DS.clearSession();
      location.href = 'auth.html';
    });
  </script>

</body>
</html>
