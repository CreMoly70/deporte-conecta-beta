<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deporte Conecta ‚Äî Mapa</title>

  <link rel="stylesheet" href="css/style.css"/>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- DataService: sesi√≥n y usuarios -->
  <script src="js/dataService.js"></script>
  <script>
    // Guardia de acceso: si no hay sesi√≥n, ir a auth
    document.addEventListener('DOMContentLoaded', () => {
      if (!DS.isLoggedIn()) {
        location.href = 'auth.html';
        return;
      }
      // Pintar saludo
      const u = DS.getUserById(DS.getSessionUserId());
      document.getElementById('topUser').textContent = u?.name || u?.username || 'Usuario';
    });
  </script>
</head>
<body class="map-body">

  <!-- Barra superior compacta -->
  <header class="top-bar">
    <a href="index.html" class="back">‚Üê Men√∫</a>

    <div class="filters">
      <label class="sr-only" for="sportFilter">Deporte</label>
      <select id="sportFilter" class="select" title="Filtrar por deporte">
        <option value="">Todos los deportes</option>
        <option>F√∫tbol</option>
        <option>Baloncesto</option>
        <option>Voleibol</option>
        <option>Ciclismo</option>
        <option>Running</option>
        <option>Nataci√≥n</option>
        <option>Tenis</option>
        <option>Gym</option>
      </select>

      <label class="sr-only" for="searchText">Buscar</label>
      <input id="searchText" class="input" placeholder="Buscar nombre o deporte‚Ä¶"/>

      <button id="btnClear" class="button button--ghost" title="Limpiar filtros">Limpiar</button>
      <button id="btnAddMode" class="button" title="A√±adir ubicaci√≥n">‚ûï A√±adir</button>
      <button id="btnFav" class="button button--ghost" title="Ver favoritos">‚òÖ Favoritos</button>
      <button id="btnNear" class="button button--ghost" title="Cerca de m√≠">üìç Cerca</button>
    </div>

    <div class="filters">
      <span>Hola, <strong id="topUser">Usuario</strong></span>
      <button id="btnLogout" class="button button--ghost" title="Cerrar sesi√≥n">Salir</button>
    </div>
  </header>

  <!-- Mapa -->
  <div id="map" class="map" role="application" aria-label="Mapa colaborativo"></div>

  <!-- Barra de estad√≠sticas -->
  <div id="statsBar" class="header-small" style="padding:8px 16px; opacity:.95;"></div>

  <!-- Panel flotante: A√±adir ubicaci√≥n -->
  <aside id="addPanel" class="card floating-panel" hidden style="padding:12px; max-width:520px">
    <h2>Nuevo lugar</h2>
    <p>Activa ‚ÄúA√±adir‚Äù y haz clic en el mapa. Ajusta el pin si es necesario.</p>
    <div class="grid2">
      <label>
        <span>Nombre del lugar</span>
        <input id="name" class="input" placeholder="Cancha, parque, pista‚Ä¶"/>
      </label>
      <label>
        <span>Deporte</span>
        <select id="sport" class="select">
          <option>F√∫tbol</option>
          <option>Baloncesto</option>
          <option>Voleibol</option>
          <option>Ciclismo</option>
          <option>Running</option>
          <option>Nataci√≥n</option>
          <option>Tenis</option>
          <option>Gym</option>
        </select>
      </label>
    </div>
    <label style="display:block; margin-top:8px">
      <span>Horario (opcional)</span>
      <input id="hours" class="input" placeholder="Ej. 6:00‚Äì10:00 y 16:00‚Äì20:00"/>
    </label>
    <label style="display:block; margin-top:8px">
      <span>M√°s informaci√≥n (opcional)</span>
      <input id="more" class="input" placeholder="Canchas techadas, iluminaci√≥n, costo, acceso‚Ä¶"/>
    </label>
    <div class="form-buttons">
      <button id="btnCancelAdd" class="button button--ghost">Cancelar</button>
      <button id="btnSave" class="button">Guardar</button>
    </div>
  </aside>

  <!-- Panel lateral: Favoritos -->
  <aside id="favPanel" class="side-panel" hidden>
    <div class="side-head">
      <strong>Mis favoritos</strong>
      <button id="btnCloseFav" class="button button--ghost">Cerrar</button>
    </div>
    <div id="favList" class="side-list"></div>
  </aside>

  <!-- Panel ‚ÄúCerca de m√≠‚Äù -->
<!-- ===== Panel "Cerca de m√≠" ===== -->
<div class="near-panel" id="nearPanel" hidden>
  <div class="near-head">
    <h3>Cerca de m√≠</h3>
    <button class="button button--ghost" id="btnCloseNear">Cerrar</button>
  </div>

  <div class="near-section">
    <label>Ubicaci√≥n</label>
    <div class="near-buttons">
      <button class="button" id="btnNearLocate">üìç Usar mi ubicaci√≥n</button>
      <button class="button button--ghost" id="btnNearSelect">üñ±Ô∏è Seleccionar en el mapa</button>
    </div>
  </div>

  <div class="near-section">
    <label for="nearRadius">Radio (km)</label>
    <input type="number" id="nearRadius" class="input" value="3" min="0.1" step="0.1">
  </div>

  <div class="near-section near-actions">
    <button class="button" id="btnNearApply">Aplicar</button>
    <button class="button button--ghost" id="btnNearClear">Limpiar</button>
  </div>

  <p class="near-hint">
    Consejo: usa ‚ÄúSeleccionar en el mapa‚Äù para definir el centro manualmente o ‚ÄúUsar mi ubicaci√≥n‚Äù para centrar en tu posici√≥n.
  </p>
</div>


  <!-- Modal Informaci√≥n -->
  <section id="infoModal" class="modal" hidden>
    <div class="modal-backdrop" data-close></div>
    <article class="modal-card">
      <div class="modal-head">
        <h3 id="infoTitle" style="margin:0">Informaci√≥n del lugar</h3>
        <button id="infoClose" class="button button--ghost">Cerrar</button>
      </div>
      <div id="infoBody" class="modal-body"></div>
    </article>
  </section>

  <!-- App JS -->
  <script src="js/map.js"></script>
  <script>
    // Cerrar sesi√≥n
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      DS.clearSession();
      location.href = 'auth.html';
    });
  </script>
</body>
</html>
